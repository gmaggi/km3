Project description
===================

The online recontruction system (ORS) is heavely dependent on JPP. The latter is the main KM3NeT software used to perform the Data Aquisition System (DAQ) in KM3NeT. Furthermore, JPP also provides fit reconstruction algorithms which have been adapted to be used in the ORS.   

.. note::
   All the codes/applications starting with capital "J", belong to JPP. The main author of JPP is Maarten de Jong, and a full documentation is in `JPP common pages`_.

.. _JPP common pages: https://common.pages.km3net.de/jpp/index.html

The ORS reconstructs events in real time. This means that as soon as an DAQ event is built by JDataFilter at JPP, this is obtained by the ORS via socket conection, which subsequently will produce as output the results of two reconstruction algortihm, 

* Muon reconstruction (JMuonGandalf) and 
* The Shower reconstruction 

  - AANetShower for ARCA, the main author is Aart Heijboer, nevertheless, this has been adapted for being used in the ORS. 

  - For ORCA shower reconstruction, the main author is Alba Domi and this is also implemented in JPP. 


Explanation
-----------

The first stages of the data taken consists in,

    1. *Control Unit*, in short, this takes care of the detector. The main author is Cristiano Bozza and a detailed documentation can be found in `Wiki Control Unit`_

    2. *DataQueue* "provides first stage of on-line data aggregation". The author is Carmelo Peregrino and further details can be found in `Wiki DataQueue`_ 

    3. A first data filter is applied, and the *JDAQEvents* are created (these are tagged as **IO_EVT**). This process is lead by the *JDataFilter* application:

      		    - Until this stage, the offline and online information is processed in the same way. 
		    - All the comunication here is handled via socket connection and through a server that is handled by the *JLigier* application. We refer to the latter as the *Main-JLigier*.         

    4. Followed to the JDAQEvent formation, the offline and online systems become decoupled. The offline system proceeds writting JDAQEvents to a file via the *JDataWriter* application.
   
The ORS starts to function when this receives events from a server which is called *LigierMirror*, this plays the same role than Main-JLigier, so provides JDAQEvents to clients.

We keep separated offline from online. The Main-JLigier is just dedicated for offline, and is also part of JPP (*JLigier*). The LigierMirror is dedicated for online resources, as the `online monitoring`_, the author of the LigierMirror is Tamas Gal.

.. _Wiki DataQueue: https://wiki.km3net.de/index.php/DataQueue

.. _online monitoring: http://antorcaoff1.in2p3.fr:8081/index.html

.. _Wiki Control Unit: https://wiki.km3net.de/index.php/Control_Unit_installation,_user_manual_and_data_file_documentation

In order to reconstruct -all- events in real time (see introduction), a set of clients has to receive the data carried by a group of JDAQEvents. This distribution task is handled by the *JDistributer* application at JPP.

.. note::

   There are two objects that carry the information generated by the ORS, ``KM3OnlineEvent`` and ``KM3OnlineGraphic``. Those two have different tasks, the former is used to carry all the information needed for multi-messenger analyses, whereas the latter has the responsabiity to contain all the needed information for showing events in a graphic mode, as an event viewer.       

KM3OnlineEvent Data Stream
**************************

This is a light object, which consists of 256 bytes, and is indentified with the tag **IO_OLINE**. The main usage for this data stream is for physics analyses, as multi-messengers.

To handle it via socket connection, the order of the data stream is the following:

+-----------------+---------------------------+--------------+
| name            | type                      | size (bytes) |
+=================+===========================+==============+
|JDAQPreamble     | int x2                    | 8            |
+-----------------+---------------------------+--------------+
| Detector ID     | int                       | 4            |
+-----------------+---------------------------+--------------+
| Run Number      | int                       | 4            |
+-----------------+---------------------------+--------------+
| Frame Index     | int                       | 4            |
+-----------------+---------------------------+--------------+
| Trigger Counter | unsigned long long int    | 8            |
+-----------------+---------------------------+--------------+
| UTC seconds     | unsigned int              | 4            |
+-----------------+---------------------------+--------------+
| Shower fit      | see table below           | 84           |
+-----------------+---------------------------+--------------+
| Track fit       | see table below           | 84           |
+-----------------+---------------------------+--------------+
| MultiVariables  | see second table below    | 56           |
+-----------------+---------------------------+--------------+


The info for a fit (class name ``JFit``) is:

    +---------+----------+--------------+
    | name    | type     | size (bytes) |
    +=========+==========+==============+
    | pos X   | double   | 8            |
    +---------+----------+--------------+
    | pos Y   | double   | 8            |
    +---------+----------+--------------+
    | pos Z   | double   | 8            |
    +---------+----------+--------------+
    | dir X   | double   | 8            |
    +---------+----------+--------------+
    | dir Y   | double   | 8            |
    +---------+----------+--------------+
    | dir Z   | double   | 8            |
    +---------+----------+--------------+
    | Energy  | double   | 8            |
    +---------+----------+--------------+
    | Quality | double   | 8            |
    +---------+----------+--------------+
    | Time    | double   | 8            |
    +---------+----------+--------------+
    | Type    | int      | 4            |
    +---------+----------+--------------+
    | Staus   | int      | 4            |	
    +---------+----------+--------------+
    | NDF     | int      | 4            |	
    +---------+----------+--------------+


The info for MultiVariables (class name ``KM3OnlineMultivariables``) is

    +---------------+----------+--------------+
    | name          | type     | size (bytes) |
    +===============+==========+==============+
    | CoC           | double   | 8            |
    +---------------+----------+--------------+
    | ToT           | double   | 8            |
    +---------------+----------+--------------+
    | Charge Above  | double   | 8            |
    +---------------+----------+--------------+
    | Charge Below  | double   | 8            |
    +---------------+----------+--------------+
    | Charge Ratio  | double   | 8            |
    +---------------+----------+--------------+
    | Delta Pos Z   | double   | 8            |
    +---------------+----------+--------------+
    | N Trig Hits   | unsigned | 4            |
    +---------------+----------+--------------+
    | N Snap Hits   | unsigned | 4            |
    +---------------+----------+--------------+
   


The output (``std::ostream``) displays (numbers have no meaning)::
   
	DetectorID    : 29
   	RunNumber     : 2868
   	FrameIndex    : 74770
   	TriggerCouter : 1778
   	UTCseconds    : 1510279477
   	JGandalf: 
   	KM3OnlineTrack: 
   	X       :     22.22
   	Y       :      7.25
   	Z       :    166.89
   	DX      :     0.294
   	DY      :     0.166
   	DZ      :    -0.941
   	Energy  :     0.000
   	Quality :    33.050
   	Time    :   67762104.013
   	Type    :         3
   	Status  :         1
   	NDF     :        16
   	***Shower: 
   	KM3OnlineTrack: 
   	X       :      0.00
   	Y       :      0.00
   	Z       :      0.00
   	DX      :     0.000
   	DY      :     0.000
   	DZ      :     0.000
   	Energy  :     0.000
   	Quality :     0.000
   	Time    :     0.000
   	Type    :        -1
   	Status  :        -1
   	NDF     :        -1 



KM3OnlineGraphic Data Stream
****************************

This object contains the hits, therefore, the size varies according to the number of hits.

This event is sent to the LigierMirror every a certain time interval (10 secs for example), and is indentified with the tag **IO_RECO**. The main usage of this data stream is for graphic purposes, as the online monitoring.


The transmited data is:

+-----------------+---------------------------+----------------+
| name            | type                      | size (bytes)   |
+=================+===========================+================+
|JDAQPreamble     | int x2                    | 8              |
+-----------------+---------------------------+----------------+
| Detector ID     | int                       | 4              |
+-----------------+---------------------------+----------------+
| Run Number      | int                       | 4              |
+-----------------+---------------------------+----------------+
| Frame Index     | int                       | 4              |
+-----------------+---------------------------+----------------+
| UTC second      | unsigned int              | 4              |
+-----------------+---------------------------+----------------+
| UTC nanoseconds | unsigned int              | 4              |
+-----------------+---------------------------+----------------+
| Triggered Hits  | see `here`_               | 18 a-single-hit|
+-----------------+---------------------------+----------------+
| Snap Shot Hits  | see `here`_               | 10 a-single-hit|
+-----------------+---------------------------+----------------+
| Track fit       | see table above           | 84             |
+-----------------+---------------------------+----------------+

.. _here: https://wiki.km3net.de/index.php/Dataformats



Machines at the shore stations
------------------------------

* At the **ARCA** side, the connection is via Virtual Private Networks (VPN). To get access, follow the next step:

  - Contact Emidio Giorgio and Simone Biagi to set your VPN account

  - ssh into user_name@172.16.65.55 (*km3bastion*) and then into user_name@192.168.0.239 (*supernova*)

  - Normally, you should find the necessary packages in */home/gmaggi/online_reco_software/* at the supernova machine, this contains the following, two directories with a JPP and onlineSoftware packages, and a set_online_tools.sh script. Source the ``set_online_tools.sh`` script and should get the environment variables. If you do not find these packages, you can obtain `JPP`_ and `onlineSoftware`_ from our Git repository.

  - You should connect to the LigierMirror: 192.168.0.123:5553, and send both ``KM3OnlineGraphic`` and ``KM3OnlineEvent`` to the same machine. An example how to run the master script is::
   

	KM3OnlineMain.py --in_hostname 192.168.0.123:5553 --destination_ports 5555 --listener 172.16.65.58:5553 --detector_file $ONLINE_DATA/KM3NeT_00000042_20190218.detx --muon_parameters $ONLINE_DATA/muonReconstruction_parameters_arca_1DU.txt --n_ports 1


* At the **ORCA** side. To get access, follow the next step:

  - Contact Tamas Gal and Alexander EnzenhÃ¶fer to get access to @antorcaoff1.in2p3.fr (this machine is located at IMP) 

  - ssh into @antorcaoff1.in2p3.fr

  - Normally, you should find the necessary packages in */home/gmaggi/online_reco_software/*, then proceed idem as above

  - You should connect to the LigierMirror: 193.48.106.31:55530, and send both KM3OnlineGraphic and KM3OnlineEvent to the same machine. An example how to run the master script is::

    	 KM3OnlineMain.py --in_hostname 127.0.0.1:55530 --detector_file $ONLINE_DATA/KM3NeT_00000043_20190222.detx --listener 55530 --destination_ports 5555 --n_ports 1 --muon_parameters $ONLINE_DATA/muonReconstruction_parameters_orca_1DU.txt
    

.. warning::

   Do not attempt to send ARCA and ORCA data stream to the same server. They have the same tags and they are represented by the same object (this is the same situation that would happen for other information transmited via socket, as the JDAQEvent's). The only way that they can be distinguished by the detector ID. 


.. _JPP: https://git.km3net.de/common/jpp
.. _onlineSoftware: https://git.km3net.de/common/onlineSoftware 


How could one read this Online Data Stream?
-------------------------------------------
  
The data stream carried by the ORS is not meant for being read in real time for any person. This data stream is meant for handling alerts and some KM3NeT graphic representation. Nevertheless, in case that you are taking care of this package or are allowed to make some tests, to read this data stream, you could proceed as following:

* Contact the persons indicated above to find out how you can connect to JLigierMirror, normally the hostname:port for @antorcaoff1.in2p3.fr at ORCA is *193.48.106.31:55530*, and *192.168.0.123:5553* for ARCA. These ports, normally correspond to the LigierMirror's.   

* Once you are connected, an easy way to check weather you are actually receiving data is via the following JPP command ``JGetMessage -H hostname:port -t tag_name``. You should see as an output the size (n bytes) of the tag that you are reading, e.g::

      [gmaggi@antorcaoff1 ~]$ JGetMessage -H 193.48.106.31:55530 -t IO_RECO
      IO_RECO      3532
      IO_RECO      2282
      IO_RECO      1538

      [gmaggi@antorcaoff1 ~]$ JGetMessage -H 193.48.106.31:55530 -t IO_OLINE
      IO_OLINE      256
      IO_OLINE      256
      IO_OLINE      256
      IO_OLINE      256



* There are examples in the onlineSoftware KM3NeT Git repository that would help you to read the data stream produced by the ORS. 

  	- (Desired) Examples that use the objects defined in the onlineSoftware are `KM3OnlineRead`_ and `KM3OnlineReadGraphic`_


  	- (When you want to do things just reading binary data obtained via socket. This does not need the onlineSoftware package, but still you need JPP) Examples that do not need the whole onlineSoftware are: `KM3OnlineReadGraphicTag`_ and `KM3OnlineReadTag`_ .

.. _KM3OnlineReadGraphicTag : https://git.km3net.de/common/onlineSoftware/blob/master/examples/KM3OnlineReadGraphicTag.cc

.. _KM3OnlineReadTag : https://git.km3net.de/common/onlineSoftware/blob/master/examples/KM3OnlineReadTag.cc  
  
.. _KM3OnlineRead : https://git.km3net.de/common/onlineSoftware/blob/master/examples/KM3OnlineRead.cc

.. _KM3OnlineReadGraphic : https://git.km3net.de/common/onlineSoftware/blob/master/examples/KM3OnlineReadGraphic.cc  

   		     

Data flow
---------

This is the data flow for the multi-applications that are involved in the ORS. Nonetheless, few of them are not absolutly needed to run the online reconstructions, as ``KM3OnlineFileWriter``. This application belongs to the *utilities* directory in `onlineSoftware`_. See further explanation in :ref:`KM3OnlineFileWritter`. There is also another application ``KM3OnlineEventViewer`` that momentarily provides an 3d event display based on facilities in AANet, which runs in the marantares2 machine at CPPM. This 3D events can be visualized `in this link`_.

.. _in this link : https://www.cppm.in2p3.fr/~gmaggi/online_orca_event_viewer/?f=online_event.js.gz  


.. uml::

   @startuml

   [*] --> LigierMirror
   LigierMirror --> KM3OnlineRecos : IO_EVT
   KM3OnlineRecos --> LigierMirror : IO_RECO, IO_OLINE

   LigierMirror --> KM3OnlineFileWriter : IO_OLINE
   LigierMirror --> OnlineMonitoring : IO_RECO
   LigierMirror --> KM3OnlineEventViewer : IO_RECO
  

   LigierMirror : Provides JDAQEvent data stream, which contains the hit information

   
  state KM3OnlineRecos {

        [*] --> FastRecos : Start iteration through \nJLigierObjectIterator to get JDAQEvents
        FastRecos --> JPPRecos : No cuts are applied so far
        JPPRecos --> KM3OnlineObjets : No cuts are applied so far
        KM3OnlineObjets --> [*] : KM3OnlineObjects are sent \nto the LigierMirror

	KM3OnlineRecos: Cpp, JPP
	FastRecos: DeltaPos, LineFit, etc
	JPPRecos : Until JMuonGandalf		
	KM3OnlineObjets : KM3OnlineEvent and KM3OnlineGraphic are created
  }

  state KM3OnlineFileWriter {

  	[*] --> JControlHostObjectIterator 
        JControlHostObjectIterator --> WriteFiles
        WriteFiles --> [*]  

       KM3OnlineFileWriter: Cpp, BOOST, JPP, AANet
       JControlHostObjectIterator : Get KM3OnlineEvents
       WriteFiles: AANet format (fit result and minimun DAQ info) organized by detector and run ID
  }

  state OnlineMonitoring {

  	OnlineMonitoring: Tamas's tool to display zenith(Gandalf)
  }

  state KM3OnlineEventViewer {

  	KM3OnlineEventViewer: 3D event diplay based on AANet facilities.
  }


   @enduml


.. state KM3MMEventSelection {

  	[*] --> JControlHostObjectIterator3 
        JControlHostObjectIterator3 --> SelectUpGoingEvents: Get recontructed events
	SelectUpGoingEvents --> SelectecNuEvents
        SelectecNuEvents --> [*]
        
	KM3MMEventSelection: Python 
	JControlHostObjectIterator3: Get KM3OnlineEvents  
	SelectUpGoingEvents: JMuonGandalf dir_z >=0
	SelectecNuEvents: based on machine learning
..  }


